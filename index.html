<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Target Baca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://placehold.co/192x192/000000/FFFFFF?text=Q" type="image/png">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#1E293B',
                            200: '#1A202C',
                            300: '#2D3748',
                            400: '#4A5568',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .fixed-bottom-section {
            box-shadow: 0 -10px 15px -3px rgba(0,0,0,0.1), 0 -4px 6px -2px rgba(0,0,0,0.05);
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-300">

<div id="app" class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-2xl w-full sm:max-w-sm sm:mx-auto flex flex-col justify-between transition-all duration-300 min-h-screen">
    
    <Transition name="fade">
        <div v-if="showSettingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Pengaturan</h2>
                <div class="space-y-4">
                    <div>
                        <label for="tempNamaUser" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Nama Pengguna</label>
                        <input type="text" id="tempNamaUser" v-model="tempNamaUser" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white dark:bg-gray-600 dark:text-white p-2" placeholder="Opsional">
                    </div>
                    <div>
                        <label for="tempHalamanSaatIni" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Halaman Saat Ini</label>
                        <input type="number" id="tempHalamanSaatIni" v-model.number="tempHalamanSaatIni" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white dark:bg-gray-600 dark:text-white p-2" min="1">
                    </div>
                    <div>
                        <label for="tempTargetHarian" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Target Harian (Halaman)</label>
                        <input type="number" id="tempTargetHarian" v-model.number="tempTargetHarian" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white dark:bg-gray-600 dark:text-white p-2" min="1">
                    </div>
                    <div>
                        <label for="tempNotificationTimes" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Jam Notifikasi Bacaan (HH:mm)</label>
                        <input type="text" id="tempNotificationTimes" v-model="tempNotificationTimes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white dark:bg-gray-600 dark:text-white p-2" placeholder="Contoh: 12:00, 18:00">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pisahkan dengan koma. Gunakan format 24 jam.</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Notifikasi Bacaan</span>
                        <button @click="toggleNotifikasi" :class="{'bg-green-600': isNotifikasiDiaktifkan, 'bg-gray-300': !isNotifikasiDiaktifkan}" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            <span :class="{'translate-x-6': isNotifikasiDiaktifkan, 'translate-x-1': !isNotifikasiDiaktifkan}" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Pengingat Dzikir</span>
                        <button @click="toggleDzikir" :class="{'bg-green-600': isDzikirEnabled, 'bg-gray-300': !isDzikirEnabled}" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            <span :class="{'translate-x-6': isDzikirEnabled, 'translate-x-1': !isDzikirEnabled}" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                        </button>
                    </div>
                    <div v-if="isDzikirEnabled">
                        <label for="tempDzikirMenit" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Interval Dzikir (Menit)</label>
                        <input type="number" id="tempDzikirMenit" v-model.number="tempDzikirMenit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white dark:bg-gray-600 dark:text-white p-2" min="1">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button @click="closeSettingsModal" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 transition">Batal</button>
                    <button @click="saveAndCloseSettings" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </div>
        </div>
    </Transition>

    <div class="flex-grow flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white tracking-tight">Target Baca</h1>
            <div class="flex items-center gap-2">
                <button @click="toggleDarkMode" aria-label="Toggle Dark Mode" class="text-gray-600 dark:text-gray-200 hover:text-gray-800 dark:hover:text-white transition">
                    <svg v-if="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <button @click="openSettingsModal" aria-label="Pengaturan" class="text-gray-600 dark:text-gray-200 hover:text-gray-800 dark:hover:text-white transition transform hover:rotate-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.493 8.59a2 2 0 011.086 2.37l-2.08 3.743a1 1 0 01-1.742-.326l-.99-1.98a1 1 0 011.742-.326l.495.99.757-1.428a2 2 0 012.232-1.223zM10 18a8 8 0 100-16 8 8 0 000 16zm-1.894-3.565l-1.98-1.98a.5.5 0 01-.132-.61l.99-1.98a.5.5 0 01.871-.242l.99 1.98a.5.5 0 01-.131.61zM10 2.5a.5.5 0 00-.5.5v2a.5.5 0 001 0V3a.5.5 0 00-.5-.5z" clip-rule="evenodd"/></svg>
                </button>
            </div>
        </div>

        <div class="flex-grow">
            <div class="flex flex-col items-center mb-6">
                <p class="text-center text-sm text-gray-500 dark:text-gray-400 max-w-xs">Catat kemajuan Anda dan capai target harian.</p>
            </div>

            <div class="mb-2 bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-full rounded-full progress-bar" :style="{ width: progressPercentage + '%' }"></div>
            </div>
            <div class="text-center text-sm text-gray-600 dark:text-gray-400 mb-6 font-bold">
                {{ halamanCapaian - halamanSaatIni }} / {{ targetHarian }} halaman ({{ Math.round(progressPercentage) }}%)
            </div>

            <Transition name="fade">
                <div v-if="!isNotifikasiDiaktifkan" class="text-center text-red-500 text-sm mb-4">
                    <p>Notifikasi belum diaktifkan. Anda mungkin melewatkan pengingat penting.</p>
                </div>
                <div v-else class="text-center text-green-600 text-sm mb-4">
                    <p>Notifikasi bacaan aktif.</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pengingat akan muncul pada jam {{ notificationTimes.join(', ') }} jika target belum tercapai.</p>
                </div>
            </Transition>

            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-2xl mb-6 shadow-inner border border-gray-100 dark:border-gray-600">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-200">Target Hingga Halaman</span>
                    <span class="text-sm font-bold text-gray-800 dark:text-white">{{ targetTotalHalaman }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-200">Kekurangan Target</span>
                    <span :class="{'text-red-600 font-bold': kekuranganTarget > 0, 'text-green-600 font-bold': kekuranganTarget <= 0}">
                        {{ kekuranganTarget > 0 ? kekuranganTarget + ' halaman' : 'Target Tercapai!' }}
                    </span>
                </div>
            </div>

            <div class="mt-8">
                <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Rekap Mingguan</h2>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl mb-4">
                    <div class="text-sm font-medium text-gray-600 dark:text-gray-200">Halaman dibaca minggu ini</div>
                    <div class="text-xl font-bold text-gray-800 dark:text-white">{{ rekapMingguan }} halaman / {{ rekapMingguan/20 }} Juz</div>
                </div>

                <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Riwayat Bacaan</h2>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl h-60 overflow-y-auto">
                    <div v-if="riwayatBacaan.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-4">
                        Belum ada riwayat bacaan.
                    </div>
                    <div v-else class="space-y-2">
                        <div v-for="(hari, index) in riwayatBacaan.slice(0, 100)" :key="index" class="text-sm text-gray-800 dark:text-white">
                            {{ formatTanggal(hari.tanggal) }}: {{ hari.dari }}-{{ hari.sampai }} ({{ hari.jumlah }} hal)
                        </div>
                    </div>
                </div>
                <br><br><br><br><br>
            </div>
        </div>
    </div>

    <div class="fixed-bottom-section fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 p-6 rounded-t-3xl border-t border-gray-200 dark:border-gray-700 w-full sm:max-w-sm sm:mx-auto">
        <label for="halamanCapaian" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">Sudah Sampai Halaman</label>
        <div class="flex items-center gap-2 mt-1">
            <button @click="decrementHalaman" aria-label="Kurangi" class="bg-indigo-600 text-white font-bold p-2 rounded-xl hover:bg-indigo-700 transition duration-300 w-12 h-12 flex items-center justify-center text-xl shadow-lg hover:shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
            </button>
            
            <input id="halamanCapaian" type="number" v-model.number="halamanCapaian" placeholder="Contoh: 25" class="w-full rounded-xl border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-center transition duration-200 focus:ring-2 font-bold bg-white dark:bg-gray-700 dark:text-white">
            
            <button @click="incrementHalaman" aria-label="Tambah" class="bg-indigo-600 text-white font-bold p-2 rounded-xl hover:bg-indigo-700 transition duration-300 w-12 h-12 flex items-center justify-center text-xl shadow-lg hover:shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            </button>
        </div>
    </div>
</div>

<script>
/* =========================
   Helper & Service Worker
   ========================= */
function log(...args) { console.log('[APP]', ...args); }
function warn(...args) { console.warn('[APP]', ...args); }
function err(...args) { console.error('[APP]', ...args); }

// konversi base64 VAPID -> Uint8Array (jika butuh nanti)
// function urlBase64ToUint8Array(base64String) { ... }

function nextTimeFromHHmm(hhmm) {
  const [h, m] = hhmm.split(':').map(s => Number(s));
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0, 0);
  if (d <= now) d.setDate(d.getDate() + 1);
  return d;
}

async function registerServiceWorkerForRepo() {
  if (!('serviceWorker' in navigator)) {
    warn('Service Worker tidak didukung.');
    return null;
  }
  try {
    // Tentukan base path: jika hosting di /targetBaca/ maka scope mesti /targetBaca/
    // Kita ambil dari location.pathname: ambil bagian sampai folder terakhir sebelum file
    // Contoh: https://nu2883.github.io/targetBaca/ -> base '/targetBaca/'
    let base = location.pathname;
    // Jika URL adalah /targetBaca/ atau /targetBaca/index.html -> kita ingin '/targetBaca/'
    if (!base.endsWith('/')) {
      base = base.substring(0, base.lastIndexOf('/') + 1);
    }
    const swUrl = base + 'service-worker.js';
    const reg = await navigator.serviceWorker.register(swUrl, { scope: base });
    log('Service Worker registered:', swUrl, 'scope:', base);

    // simpan reg global untuk dipakai
    window._sw_registration = reg;

    // tunggu aktif
    if (reg.installing) {
      reg.installing.addEventListener('statechange', () => {
        if (reg.active) initAfterSWReady(reg);
      });
    } else if (reg.active) {
      initAfterSWReady(reg);
    }
    return reg;
  } catch (e) {
    err('registerServiceWorkerForRepo error', e);
    return null;
  }
}

function initAfterSWReady(reg) {
  window._sw_registration = reg;
  // kirim update data awal jika controller ada
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ action: 'updateData', timestamp: Date.now() });
  }
}

/* =========================
   Notification / Scheduler
   ========================= */

let _notifTimerId = null;
let _dzikirTimerId = null;

async function ensureNotificationPermission() {
  if (!('Notification' in window)) {
    alert('Browser Anda tidak mendukung notifikasi.');
    return false;
  }
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') {
    alert('Izin notifikasi ditolak. Ubah di pengaturan browser.');
    return false;
  }
  const p = await Notification.requestPermission();
  return p === 'granted';
}

async function showNotificationNow({ title = 'Notifikasi', body = '', url = '/', icon = '/targetBaca/icon.png', tag } = {}) {
  try {
    const reg = window._sw_registration || await navigator.serviceWorker.getRegistration();
    if (reg && typeof reg.showNotification === 'function') {
      reg.showNotification(title, {
        body,
        icon,
        badge: icon,
        data: { url },
        tag: tag || undefined
      });
    } else if (Notification.permission === 'granted') {
      new Notification(title, { body, icon, data: { url }, tag: tag || undefined });
    } else {
      warn('Tidak punya permission untuk menampilkan notifikasi sekarang.');
    }
  } catch (e) {
    err('showNotificationNow error', e);
  }
}

function scheduleNextNotification(notificationTimes = ['09:00','12:00','18:00'], checkTargetFn = () => true) {
  // batalkan timer sebelumnya
  if (_notifTimerId) { clearTimeout(_notifTimerId); _notifTimerId = null; }

  // cari waktu terdekat dari daftar times
  const now = new Date();
  let nearest = null;
  for (const t of notificationTimes) {
    const d = nextTimeFromHHmm(t);
    if (!nearest || d < nearest) nearest = d;
  }
  if (!nearest) return;
  const ms = nearest.getTime() - now.getTime();
  log('Menjadwalkan notifikasi berikutnya pada', nearest.toString(), `(${Math.round(ms/1000)}s)`);

  _notifTimerId = setTimeout(async () => {
    try {
      if (typeof checkTargetFn === 'function' && !checkTargetFn()) {
        log('Kondisi target terpenuhi -> melewatkan notifikasi ini.');
      } else {
        const nama = localStorage.getItem('namaUser') || '';
        const body = nama ? `${nama}, ayo lanjut bacaan.` : 'Waktunya melanjutkan bacaan.';
        await showNotificationNow({ title: 'Pengingat Bacaan', body, url: '/', icon: '/targetBaca/icon.png', tag: 'reading-notif' });
      }
    } catch (e) {
      err('Error saat show scheduled notification', e);
    } finally {
      // jadwalkan lagi untuk waktu terdekat berikutnya
      scheduleNextNotification(notificationTimes, checkTargetFn);
    }
  }, ms);
}

function startDzikirInterval(minutes = 5) {
  stopDzikirInterval();
  if (!minutes || minutes <= 0) return;
  // tampilkan segera sekali (opsional) lalu interval
  (async () => {
    const nama = localStorage.getItem('namaUser') || '';
    const body = nama ? `${nama}, ayo berdzikir.` : 'Ayo berdzikir.';
    await showNotificationNow({ title: 'Pengingat Dzikir', body, icon: '/targetBaca/icon.png', tag: 'dzikir-notif' });
  })();

  _dzikirTimerId = setInterval(async () => {
    try {
      const nama = localStorage.getItem('namaUser') || '';
      const body = nama ? `${nama}, ayo berdzikir.` : 'Ayo berdzikir.';
      await showNotificationNow({ title: 'Pengingat Dzikir', body, icon: '/targetBaca/icon.png', tag: 'dzikir-notif' });
    } catch (e) {
      err('dzikir interval error', e);
    }
  }, minutes * 60 * 1000);
}

function stopDzikirInterval() {
  if (_dzikirTimerId) {
    clearInterval(_dzikirTimerId);
    _dzikirTimerId = null;
  }
}

function stopScheduledNotifications() {
  if (_notifTimerId) { clearTimeout(_notifTimerId); _notifTimerId = null; }
}

/* =========================
   Vue App (lengkap)
   ========================= */

const app = Vue.createApp({
  data() {
    const readNumber = (key, fallback) => {
      const raw = localStorage.getItem(key);
      const n = Number(raw);
      return Number.isFinite(n) && !Number.isNaN(n) ? n : fallback;
    };
    const savedDarkMode = localStorage.getItem('darkMode');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDarkMode = savedDarkMode !== null ? savedDarkMode === 'true' : systemPrefersDark;
    if (initialDarkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');

    const savedTimes = JSON.parse(localStorage.getItem('notificationTimes') || 'null');

    return {
      namaUser: localStorage.getItem('namaUser') || '',
      halamanSaatIni: readNumber('halamanSaatIni', 1),
      halamanCapaian: readNumber('halamanCapaian', readNumber('halamanSaatIni', 1)),
      targetHarian: readNumber('targetHarian', 20),

      isNotifikasiDiaktifkan: localStorage.getItem('isNotifikasiDiaktifkan') === 'true',
      isDzikirEnabled: localStorage.getItem('isDzikirEnabled') === 'true',
      dzikirMenit: readNumber('dzikirMenit', 5),

      notificationTimes: savedTimes || ['09:00', '12:00', '18:00'],

      darkMode: initialDarkMode,
      showSettingsModal: false,
      riwayatBacaan: JSON.parse(localStorage.getItem('riwayatBacaan') || '[]'),
      showAllHistory: false,

      tempNamaUser: localStorage.getItem('namaUser') || '',
      tempHalamanSaatIni: readNumber('halamanSaatIni', 1),
      tempTargetHarian: readNumber('targetHarian', 20),
      tempDzikirMenit: readNumber('dzikirMenit', 5),
      tempNotificationTimes: savedTimes ? savedTimes.join(', ') : '09:00, 12:00, 18:00'
    };
  },
  computed: {
    kekuranganTarget() {
      const kekurangan = this.targetHarian - (this.halamanCapaian - this.halamanSaatIni);
      return Math.max(0, kekurangan);
    },
    targetTotalHalaman() {
      return this.halamanSaatIni + this.targetHarian;
    },
    progressPercentage() {
      const progress = this.halamanCapaian - this.halamanSaatIni;
      return Math.min((progress / this.targetHarian) * 100, 100);
    },
    rekapMingguan() {
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
      startOfWeek.setHours(0, 0, 0, 0);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      endOfWeek.setHours(23, 59, 59, 999);
      return this.riwayatBacaan.reduce((total, hari) => {
        const tanggalRiwayat = new Date(hari.tanggal);
        if (tanggalRiwayat >= startOfWeek && tanggalRiwayat <= endOfWeek) {
          return total + hari.jumlah;
        }
        return total;
      }, 0);
    }
  },
  watch: {
    halamanCapaian(newValue, oldValue) {
      if (newValue !== oldValue) {
        localStorage.setItem('halamanCapaian', String(newValue));
        this.simpanRiwayat();
        // update scheduler condition
        if (this.isNotifikasiDiaktifkan) {
          // reschedule to respect updated kekuranganTarget
          scheduleNextNotification(this.notificationTimes, () => this.kekuranganTarget > 0);
        }
      }
    },
    darkMode(newValue) {
      localStorage.setItem('darkMode', newValue);
      document.documentElement.classList.toggle('dark', newValue);
    },
    isNotifikasiDiaktifkan(newValue) {
      localStorage.setItem('isNotifikasiDiaktifkan', newValue);
      if (newValue) {
        (async () => {
          if (await ensureNotificationPermission()) {
            scheduleNextNotification(this.notificationTimes, () => this.kekuranganTarget > 0);
            // kirim data ke SW
            if (navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({
                action: 'updateData',
                namaUser: this.namaUser,
                notificationTimes: [...this.notificationTimes],
                halamanCapaian: this.halamanCapaian,
                targetHarian: this.targetHarian
              });
            }
          } else {
            this.isNotifikasiDiaktifkan = false;
          }
        })();
      } else {
        stopScheduledNotifications();
        // send stop message to SW (optional)
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ action: 'stopNotifications' });
        }
      }
    },
    isDzikirEnabled(newValue) {
      localStorage.setItem('isDzikirEnabled', newValue);
      if (newValue) {
        (async () => {
          if (await ensureNotificationPermission()) {
            startDzikirInterval(this.dzikirMenit);
            if (navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({ action: 'updateData', isDzikirEnabled: true, dzikirMenit: this.dzikirMenit });
            }
          } else {
            this.isDzikirEnabled = false;
          }
        })();
      } else {
        stopDzikirInterval();
        if (navigator.serviceWorker.controller) navigator.serviceWorker.controller.postMessage({ action: 'updateData', isDzikirEnabled: false });
      }
    },
    kekuranganTarget(newValue, oldValue) {
      if (newValue <= 0 && oldValue > 0) {
        // target tercapai -> hentikan notifikasi jadwal
        stopScheduledNotifications();
        console.log("Target harian tercapai, notifikasi dihentikan.");
      }
      // kirim updateData ke SW agar SW punya snapshot terbaru (jika mau)
      if (navigator.serviceWorker.controller) {
        const payload = {
          action: 'updateData',
          namaUser: this.namaUser,
          kekuranganTarget: this.kekuranganTarget,
          halamanCapaian: this.halamanCapaian,
          targetHarian: this.targetHarian,
          notificationTimes: [...this.notificationTimes]
        };
        navigator.serviceWorker.controller.postMessage(payload);
      }
    }
  },
  methods: {
    initNotifications() {
      // dipanggil setelah SW siap
      if (this.isNotifikasiDiaktifkan && Notification.permission === 'granted') {
        scheduleNextNotification(this.notificationTimes, () => this.kekuranganTarget > 0);
      }
      if (this.isDzikirEnabled && Notification.permission === 'granted') {
        startDzikirInterval(this.dzikirMenit);
      }
    },
    incrementHalaman() { this.halamanCapaian++; },
    decrementHalaman() { if (this.halamanCapaian > 1) this.halamanCapaian--; },
    openSettingsModal() {
      this.tempNamaUser = this.namaUser;
      this.tempHalamanSaatIni = this.halamanSaatIni;
      this.tempTargetHarian = this.targetHarian;
      this.tempDzikirMenit = this.dzikirMenit;
      this.tempNotificationTimes = this.notificationTimes.join(', ');
      this.showSettingsModal = true;
    },
    closeSettingsModal() { this.showSettingsModal = false; },
    saveAndCloseSettings() {
      this.namaUser = this.tempNamaUser || '';
      this.halamanSaatIni = Math.max(1, Number(this.tempHalamanSaatIni) || 1);
      this.targetHarian = Math.max(1, Number(this.tempTargetHarian) || 1);
      this.dzikirMenit = Math.max(1, Number(this.tempDzikirMenit) || 5);

      const newTimes = this.tempNotificationTimes.split(',').map(s => s.trim()).filter(s => s.match(/^\d{1,2}:\d{2}$/));
      this.notificationTimes = newTimes.length > 0 ? newTimes : ['09:00', '12:00', '18:00'];

      localStorage.setItem('namaUser', this.namaUser);
      localStorage.setItem('halamanSaatIni', String(this.halamanSaatIni));
      localStorage.setItem('targetHarian', String(this.targetHarian));
      localStorage.setItem('dzikirMenit', String(this.dzikirMenit));
      localStorage.setItem('notificationTimes', JSON.stringify(this.notificationTimes));

      // reschedule jika notifikasi aktif
      if (this.isNotifikasiDiaktifkan) {
        scheduleNextNotification(this.notificationTimes, () => this.kekuranganTarget > 0);
      }
      if (this.isDzikirEnabled) {
        startDzikirInterval(this.dzikirMenit);
      } else {
        stopDzikirInterval();
      }

      this.showSettingsModal = false;
    },
    toggleDarkMode() { this.darkMode = !this.darkMode; },
    formatTanggal(tanggalString) {
      const date = new Date(tanggalString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    },
    simpanRiwayat() {
      const today = new Date().toISOString().split('T')[0];
      const existingIndex = this.riwayatBacaan.findIndex(item => item.tanggal === today);
      const riwayatHariIni = {
        tanggal: today,
        dari: this.halamanSaatIni,
        sampai: this.halamanCapaian,
        jumlah: this.halamanCapaian - this.halamanSaatIni,
        target: this.targetHarian,
        targetTercapai: (this.halamanCapaian - this.halamanSaatIni) >= this.targetHarian
      };
      if (existingIndex >= 0) {
        this.riwayatBacaan.splice(existingIndex, 1, riwayatHariIni);
      } else {
        this.riwayatBacaan.unshift(riwayatHariIni);
      }
      localStorage.setItem('riwayatBacaan', JSON.stringify(this.riwayatBacaan));
    },
    async toggleNotifikasi() {
      if (!("Notification" in window)) {
        alert('Browser Anda tidak mendukung notifikasi.');
        return;
      }
      if (Notification.permission === 'denied') {
        alert('Izin notifikasi ditolak. Silakan ubah di pengaturan browser Anda.');
        return;
      }
      if (this.isNotifikasiDiaktifkan) {
        this.isNotifikasiDiaktifkan = false;
      } else {
        const permission = await Notification.requestPermission();
        if (permission === "granted") {
          this.isNotifikasiDiaktifkan = true;
        } else {
          this.isNotifikasiDiaktifkan = false;
        }
      }
    },
    mulaiNotifikasi() {
      // dipanggil jika ingin memaksa notifikasi segera (button test)
      if (this.isNotifikasiDiaktifkan) {
        showNotificationNow({ title: 'Tes Notifikasi', body: 'Ini notifikasi tes', icon: '/targetBaca/icon.png' });
      } else {
        alert('Aktifkan notifikasi terlebih dahulu.');
      }
    },
    stopNotifikasi() {
      this.isNotifikasiDiaktifkan = false;
      stopScheduledNotifications();
      if (navigator.serviceWorker.controller) navigator.serviceWorker.controller.postMessage({ action: 'stopNotifications' });
    },
    async toggleDzikir() {
      if (!("Notification" in window)) {
        alert('Browser Anda tidak mendukung notifikasi.');
        return;
      }
      if (Notification.permission === 'denied') {
        alert('Izin notifikasi ditolak. Silakan ubah di pengaturan browser Anda.');
        return;
      }
      if (this.isDzikirEnabled) {
        this.isDzikirEnabled = false;
      } else {
        const permission = await Notification.requestPermission();
        if (permission === "granted") {
          this.isDzikirEnabled = true;
        } else {
          this.isDzikirEnabled = false;
        }
      }
    },
    mulaiDzikir() {
      if (this.isDzikirEnabled) startDzikirInterval(this.dzikirMenit);
    },
    stopDzikir() {
      stopDzikirInterval();
    }
  },
  async mounted() {
    // handle lastAccessedDate logic (copy dari kode Anda)
    function localDateKey() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
    const lastAccessedDate = localStorage.getItem('lastAccessedDate');
    const todayKey = localDateKey();

    if (lastAccessedDate !== todayKey) {
      const lastCapaian = Number(localStorage.getItem('halamanCapaian')) || this.halamanSaatIni;
      const halamanAwalHariLalu = Number(localStorage.getItem('halamanSaatIni')) || 1;
      const riwayatHariLalu = this.riwayatBacaan.find(item => item.tanggal === lastAccessedDate);
      if (lastAccessedDate && !riwayatHariLalu) {
        const riwayatKemarin = {
          tanggal: lastAccessedDate,
          dari: halamanAwalHariLalu,
          sampai: lastCapaian,
          jumlah: lastCapaian - halamanAwalHariLalu,
          target: this.targetHarian,
          targetTercapai: (lastCapaian - halamanAwalHariLalu) >= this.targetHarian
        };
        this.riwayatBacaan.unshift(riwayatKemarin);
        localStorage.setItem('riwayatBacaan', JSON.stringify(this.riwayatBacaan));
      }
      this.halamanSaatIni = lastCapaian;
      this.halamanCapaian = lastCapaian;
      localStorage.setItem('halamanSaatIni', String(this.halamanSaatIni));
      localStorage.setItem('halamanCapaian', String(this.halamanCapaian));
      localStorage.setItem('lastAccessedDate', todayKey);
    }

    // Registrasi Service Worker (sesuaikan scope otomatis)
    await registerServiceWorkerForRepo();

    // Init notifikasi/dzikir jika permission sudah granted dan flag aktif
    if (this.isNotifikasiDiaktifkan && Notification.permission === 'granted') {
      scheduleNextNotification(this.notificationTimes, () => this.kekuranganTarget > 0);
    }
    if (this.isDzikirEnabled && Notification.permission === 'granted') {
      startDzikirInterval(this.dzikirMenit);
    }

    // listen message dari SW (opsional, untuk debug)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (ev) => {
        log('msg from SW', ev.data);
      });
    }
  }
});

app.mount('#app');
</script>

</body>
</html>
